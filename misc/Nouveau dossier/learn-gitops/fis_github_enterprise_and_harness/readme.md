## Getting started:
After solving user access prmissions issues (https://wiki.fnis.com/display/cmtech/GHE+-+Getting+Started) we can start start using the GHE platform.
To start using GHE + Harness follow below steps:

- Access `Github Enterprise` application from the FIS MyApps `https://myapplications.microsoft.com/`

## Getting started by following DevDays on youtube:
Below steps are described ifrom the youtube DevDays recording under -- `https://www.youtube.com/watch?v=Mh8FvsuhWNM`. 
- You can find above resource by searching in Google using keywords: Github actions + harness integration
- We can also read the documentation under -- `https://developer.harness.io/docs/continuous-delivery/get-started/cd-tutorials/e2e-pipeline/`

Steps:
  Env setup & pre-requisites:
  1. Open a new Harness account and select Delivery pipeline not integratin as this lab will demo both:
    - A new account has been created and saved to vault
  2. Create a a Github API token:
    - Don't use this repo as we are not allowed to fork projects here for this purpose of this workshop -- A token is already created for the FIS Github Enterprise (GHE) account
    - A token is already created for my personal Github account (szairi2011@gmail.com)
  3. Similarly create an access token to the Github account:
    - A token is already created o push and pull images from docker cli
  4. Boot up the cluster:
    - Start VM# vlmazsgw-lx2 from Azure portal
    - Create an SSH tunnel to the cluster through this VM; already set localy through Putty
  5. Check few commands to make sure the cluster is up and running:
    - kubectl cluster-info
  6. Set up harness CLI:
    - Download cli from Github -- e.g. download latest harness realease from https://github.com/harness/harness-cli/releases
    - To mkae the harness cli available globally add localtion of harness cli to use env var PATH
    - Check that harness cli is working in the local env:
      > harness -v --> this will display the harness version
    - To be able to use Harness cli through the harness.io, we need to login first:
      - > harness login --api-key <HARNESS_API_KEY> --account-id <HARNESS_ACCOUNT_ID>
      NB: Harness API_KEY and account id are set up in my secrets repo

  Lab steps:
  # CI part of the Lab -- Build the app and push the image to Docker hub 
  - Clone the Github workshop project locally:  
    - Fork the project https://github.com/harness-community/harness-gitops-workshop
    - Then, clone the project locally -- > git clone https://github.com/szairi_2011/harness-gitops-workshop.git
  - A number of harness resource entities needs to be created for this pipeline:
    - Create the github secret in harness, so that we can automate access from Harness to Github -- the cli-manifests/github-connector.yaml is using the personal access token (PAT) ref github_pat so we can call harness resource with the same name below: (NB: If you make a mistake typing the commands below, we just update the entities by running the same commands again applying the same paradigm style as in Kubernetes ecosystem where we don't ned to delete and recretae resources just apply the updated declarative manifest or details again)
      > harness secret apply --token <GITHUB_API_TOKEN> --secret-name "github_pat"
    - Similarly create the Docker HUB secret resource in Harness:
      > harness secret apply --token <DOCKERHUB_API_TOKEN> --secret-name "docker_secret"
    - Create two connector entities in Harness one to connect to Docker Hub and another to Github:
      > harness connector --file <path_to_github_connector_manifest> apply
      > harness connector --file <path_to_dockerhub_connector_manifest> apply
    - Create the Harness pipeline:
      - First, we need to update the cipipeline.yaml manifest to use the right dockerhub username. For this, replace DOCKER_USERNAME by soulou2019 in my case
      - > harness ci pipeline --file <path_to_cipipeline_yaml_file> apply --> The cipipeline manifest file will allow harness to build the image and deploy to Duckerhub via the previously created Docker Hub connector entity.
      NB: If you get the message `Please enable CI free plan or reach out to support.` --> Go to Harness portal uner enable the Continuous Integration free plan (By default only CD pipeline is enabled in Harness)
  
  # GitOps - Set the ArgoCD or Flux agent 
    Here we will setup a GitOps application in Harness to automate all the build and deployment steps instead of relying on the linear manual steps we have been doing in the CI section above.
    - First we need to make sure a GitOps agent is installed in the cluster. For this, we can use the Harness portal under Deployments/GitOps page -- go to settings and slect Harness that already exists it is under argocd namespace.
    - Then download or copy resp. the autogenerated helm chart or the manifest, and run the helm or kubectl manifest command suggested in Harness portal --> this will create/update the argocd agent resources in K8s cluser
    NB: At this stage the connection between the K8s cluster and Harness is not yet established, we will do this below 
    - Make the argocd gitopsagent entity name available through the terminal environment variable for example to use it later through the haness cli
      - > export AGENT_NAME=gitopsagent 
      - Modify the cli-manifests/gitops-cluster.yaml to update the k8s control plane for the master node
      - > harness gitops-cluster --file cli-manifests/gitops-cluster.yaml apply \
          --agent-identifier $AGENT_NAME
      NB: I had to create the cluster manually from the Harness portal for the SGW Azure AKS.
    - Create a Github Gitops repo entity in Harness using command below:
      - First modify the GITHUB_USERNAME in the repo url inside the manifest, then create the GitOps Repo entity in Harness
      - Second make sure the gitopsagent env variable is set in the current terminal or run:
       > export AGENT_NAME gitopsagent
      > harness gitops-repository --file cli-manifests/gitops-repo.yaml apply \
         --agent-identifier=$AGENT_NAME
    

